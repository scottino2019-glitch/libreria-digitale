<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üìö La Tua Biblioteca Digitale</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  background: linear-gradient(135deg, #f5deb3, #deb887);
  font-family: 'Georgia', serif;
}
.book-card {
  background-color: #fff8dc;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.book-card:hover {
  transform: translateY(-5px);
}
</style>
</head>

<body class="min-h-screen p-4">

<!-- Autenticazione -->
<div id="auth-section" class="max-w-sm mx-auto bg-white rounded-lg shadow-lg p-6">
  <h1 class="text-2xl font-bold text-center mb-4">üìö La Tua Biblioteca Digitale</h1>
  <input id="email" type="email" placeholder="Email" class="w-full mb-2 p-2 border rounded">
  <input id="password" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded">
  <div class="flex justify-between">
    <button id="login-btn" class="bg-green-600 text-white px-4 py-2 rounded">Accedi</button>
    <button id="register-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Registrati</button>
  </div>
  <div id="auth-message" class="mt-4 text-center text-sm text-gray-700"></div>
</div>
  

<!-- Biblioteca -->
<div id="library-section" class="hidden max-w-5xl mx-auto">
  <div class="flex justify-between items-center mb-4">
    <input id="search-bar" type="text" placeholder="Cerca libro..." class="p-2 border rounded w-2/3">
    <div class="flex gap-2">
      <input id="file-upload" type="file" class="hidden" />
      <button id="add-book-btn" class="bg-blue-600 text-white px-4 py-2 rounded">üì§ Aggiungi Libro</button>
      <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded">üö™ Logout</button>
    </div>
  </div>
  <div id="books-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
</div>
<div id="epub-viewer" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000;">
  <button onclick="document.getElementById('epub-viewer').style.display='none'" 
    class="absolute top-4 right-4 bg-red-500 text-white px-4 py-2 rounded">Chiudi</button>
</div>

<script>
// Configurazione Supabase
const { createClient } = supabase;
const supabaseClient = createClient(
  "https://ipdhzwkyzvpwtcoekhog.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZGh6d2t5enZwd3Rjb2VraG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDYyNzMsImV4cCI6MjA3MDMyMjI3M30.50O7BW_34dD9fcza9zDi5WuhW-r9EVinopMLOnhqQtA"
);

let userId = null;

// Fetch libri
async function fetchBooks(search = "") {
  let query = supabaseClient
    .from("books")
    .select("*")
    .eq("user_id", userId)
    .order("title", { ascending: true });

  if (search) {
    query = query.ilike("title", `%${search}%`);
  }

  const { data, error } = await query;
  if (error) {
    console.error(error);
    return;
  }
  renderBooks(data);
}

// Render libri
function renderBooks(books) {
  const container = document.getElementById('books-list');
  if (!books.length) {
    container.innerHTML = '<div class="col-span-full text-center text-gray-500">Nessun libro trovato</div>';
    return;
  }
  container.innerHTML = books.map(book => `
    <div class="book relative">
      <div class="font-bold">${book.title}</div>
      <div class="text-sm mb-2">${book.author}</div>
      <div class="flex gap-2">
        <button onclick="openBook('${book.file_url}')" class="bg-yellow-500 text-white px-2 py-1 rounded">üìñ Leggi</button>
        <button onclick="editBook(${book.id})" class="bg-blue-500 text-white px-2 py-1 rounded">‚úèÔ∏è Modifica</button>
        <button onclick="deleteBook(${book.id})" class="bg-red-500 text-white px-2 py-1 rounded">üóëÔ∏è Elimina</button>
      </div>
    </div>
  `).join('');
}


// Upload libro
document.getElementById("add-book-btn").addEventListener("click", () => {
  document.getElementById("file-upload").click();
});

document.getElementById("file-upload").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const title = prompt("Titolo del libro:");
  const author = prompt("Autore del libro:");

  const { data: storageData, error: storageError } = await supabaseClient
    .storage
    .from("books-storage")
    .upload(`${userId}/${file.name}`, file, { upsert: true });

  if (storageError) {
    alert("Errore upload file: " + storageError.message);
    return;
  }

  const fileUrl = `${supabaseClient.storage.from("books-storage").getPublicUrl(`${userId}/${file.name}`).data.publicUrl}`;

  const { error: insertError } = await supabaseClient
    .from("books")
    .insert([{ title, author, file_url: fileUrl, user_id: userId }]);

  if (insertError) {
    alert("Errore salvataggio libro: " + insertError.message);
    return;
  }

  fetchBooks();
});

// Modifica libro
async function editBook(id, oldTitle, oldAuthor) {
  const newTitle = prompt("Nuovo titolo:", oldTitle);
  const newAuthor = prompt("Nuovo autore:", oldAuthor);

  const { error } = await supabaseClient
    .from("books")
    .update({ title: newTitle, author: newAuthor })
    .eq("id", id)
    .eq("user_id", userId);

  if (error) {
    alert("Errore modifica: " + error.message);
    return;
  }
  fetchBooks();
}

// Elimina libro
async function deleteBook(id) {
  if (!confirm("Sei sicuro di voler eliminare questo libro?")) return;
  const { error } = await supabaseClient
    .from("books")
    .delete()
    .eq("id", id)
    .eq("user_id", userId);
  if (error) {
    alert("Errore eliminazione: " + error.message);
    return;
  }
  fetchBooks();
}
// Open Book
function openBook(fileUrl) {
  const viewer = document.getElementById('epub-viewer');
  viewer.innerHTML = `<iframe src="${fileUrl}" class="w-full h-full" style="border:none;"></iframe>`;
  viewer.style.display = 'block';
}


// Ricerca
document.getElementById("search-bar").addEventListener("input", (e) => {
  fetchBooks(e.target.value);
});

// Autenticazione
document.getElementById("login-btn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
  document.getElementById("auth-message").textContent = error ? error.message : "Login effettuato!";
};

document.getElementById("register-btn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { error } = await supabaseClient.auth.signUp({ email, password });
  document.getElementById("auth-message").textContent = error ? error.message : "Registrazione completata! Controlla la tua email.";
};

document.getElementById("logout-btn").onclick = async () => {
  await supabaseClient.auth.signOut();
};

// Stato auth
supabaseClient.auth.onAuthStateChange((event, session) => {
  if (session) {
    userId = session.user.id;
    document.getElementById("auth-section").classList.add("hidden");
    document.getElementById("library-section").classList.remove("hidden");
    fetchBooks();
  } else {
    userId = null;
    document.getElementById("auth-section").classList.remove("hidden");
    document.getElementById("library-section").classList.add("hidden");
  }
});
</script>
</body>
</html>

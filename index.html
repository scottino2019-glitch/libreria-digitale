<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Libreria â€” Upload & Read</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body { background:#f7f5f0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }
  .card { background:white; border-radius:12px; padding:16px; box-shadow:0 6px 24px rgba(15,15,15,0.08); }
  .btn { padding:8px 12px; border-radius:8px; font-weight:600; }
  .toast { position:fixed; right:20px; bottom:20px; padding:10px 14px; border-radius:8px; color:white; display:none; z-index:9999; }
  .toast.success { background:#16a34a; } .toast.error { background:#dc2626; }
  .file-name { font-size:0.85rem; color:#374151; }
</style>
</head>
<body class="min-h-screen p-6 flex flex-col items-center">

<div class="w-full max-w-3xl">
  <header class="mb-6 flex items-center justify-between">
    <h1 class="text-2xl font-bold">ðŸ“š La Tua Libreria â€” Upload</h1>
    <div id="auth-info" class="text-sm text-gray-600">Non autenticato</div>
  </header>

  <section id="auth-card" class="card mb-4">
    <h2 class="font-semibold mb-3">Accedi o registrati</h2>
    <form id="auth-form" class="grid grid-cols-1 gap-2">
      <input id="email" type="email" placeholder="Email" class="p-2 border rounded" required />
      <input id="password" type="password" placeholder="Password" class="p-2 border rounded" required />
      <div class="flex gap-2 mt-2">
        <button id="login-btn" class="btn bg-green-600 text-white">Accedi</button>
        <button id="signup-btn" type="button" class="btn bg-blue-600 text-white">Registrati</button>
        <button id="logout-btn" type="button" class="btn bg-red-600 text-white hidden ml-auto">Logout</button>
      </div>
      <p id="signup-note" class="text-sm text-gray-500 mt-2"></p>
    </form>
  </section>

  <section id="upload-card" class="card mb-4 hidden">
    <h2 class="font-semibold mb-3">Aggiungi un libro (file)</h2>
    <div class="grid grid-cols-1 gap-2">
      <input id="title" placeholder="Titolo" class="p-2 border rounded" />
      <input id="author" placeholder="Autore" class="p-2 border rounded" />
      <label class="flex items-center gap-3">
        <input id="file-input" type="file" accept=".pdf,.epub,.txt,.md" />
        <span id="file-info" class="file-name">Nessun file selezionato</span>
      </label>
      <div class="flex gap-2">
        <button id="upload-btn" class="btn bg-amber-600 text-white">Carica e Salva</button>
        <button id="clear-btn" class="btn bg-gray-200">Annulla</button>
      </div>
    </div>
  </section>

  <section id="books-card" class="card hidden">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">I tuoi libri</h2>
      <input id="search" placeholder="Cerca titolo o autore..." class="p-2 border rounded w-1/3" />
    </div>
    <div id="books-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
/*
  File: libreria_upload_read.html
  Features:
  - Supabase Auth (signup/login/logout)
  - Upload file to Storage bucket 'books' (public)
  - Save metadata (title, author, file_url, user_id) in table 'books'
  - List user's books, search, open file in new tab, edit metadata, delete
  Requirements on Supabase:
  - Create bucket 'books' and make it public (or adapt URL logic)
  - Table 'books' with columns: id (uuid PK), title text, author text, file_url text, user_id uuid
*/

const SUPABASE_URL = "https://ipdhzwkyzvpwtcoekhog.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZGh6d2t5enZwd3Rjb2VraG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDYyNzMsImV4cCI6MjA3MDMyMjI3M30.50O7BW_34dD9fcza9zDi5WuhW-r9EVinopMLOnhqQtA";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let editingId = null;

const $ = id => document.getElementById(id);
const toast = (msg, ok=true) => {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast ' + (ok ? 'success' : 'error');
  t.style.display = 'block';
  clearTimeout(t._t);
  t._t = setTimeout(()=> t.style.display='none', 3500);
};

// --- Auth ---
$('signup-btn').onclick = async (e) => {
  e.preventDefault();
  const email = $('email').value.trim();
  const password = $('password').value;
  if(!email || !password){ toast('Email e password richieste', false); return; }
  const { data, error } = await supabase.auth.signUp({ email, password });
  console.log('signup', data, error);
  if(error){ toast('Errore registrazione: ' + error.message, false); return; }
  $('signup-note').textContent = 'Registrazione inviata â€” controlla la tua email per confermare.';
  toast('Registrazione avvenuta â€” controlla la tua email');
};

$('login-btn').onclick = async (e) => {
  e.preventDefault();
  const email = $('email').value.trim();
  const password = $('password').value;
  if(!email || !password){ toast('Email e password richieste', false); return; }
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  console.log('login', data, error);
  if(error){ toast('Errore login: ' + error.message, false); return; }
  toast('Login effettuato');
};

$('logout-btn').onclick = async () => {
  await supabase.auth.signOut();
  toast('Logout effettuato');
};

// Auth state
supabase.auth.onAuthStateChange((event, session) => {
  console.log('auth event', event, session);
  if(session && session.user){
    currentUser = session.user;
    $('auth-info').textContent = 'Connesso: ' + (currentUser.email || currentUser.id);
    $('logout-btn').classList.remove('hidden');
    $('upload-card').classList.remove('hidden');
    $('books-card').classList.remove('hidden');
    $('auth-card')?.classList && $('auth-card').classList.add('hidden');
    // show areas
    $('auth-section').classList.add('hidden');
    $('upload-card').classList.remove('hidden');
    $('books-card').classList.remove('hidden');
    loadBooks();
  } else {
    currentUser = null;
    $('auth-info').textContent = 'Non autenticato';
    $('logout-btn').classList.add('hidden');
    $('upload-card').classList.add('hidden');
    $('books-card').classList.add('hidden');
    $('auth-section').classList.remove('hidden');
  }
});

// --- Storage + DB functions ---
async function uploadFileAndSave(){
  const title = $('title').value.trim();
  const author = $('author').value.trim();
  const fileInput = $('file-input');
  const file = fileInput.files[0];
  if(!title || !author){ toast('Titolo e autore obbligatori', false); return; }
  if(!file){ toast('Seleziona un file da caricare', false); return; }

  const bucket = 'books';
  // create a unique path to avoid collisions
  const timestamp = Date.now();
  const path = `${currentUser.id}/${timestamp}_${file.name}`;

  // upload
  toast('Caricamento in corso...', true);
  try{
    const { data, error: upErr } = await supabase.storage.from(bucket).upload(path, file, { cacheControl: '3600', upsert: false });
    console.log('upload', data, upErr);
    if(upErr) { toast('Errore upload: ' + upErr.message, false); return; }

    // get public url
    const { data: urlData } = supabase.storage.from(bucket).getPublicUrl(path);
    const publicUrl = urlData.publicUrl;
    console.log('publicUrl', publicUrl);

    // save metadata to table
    const { error: dbErr } = await supabase.from('books').insert([{ title, author, file_url: publicUrl, user_id: currentUser.id }]);
    if(dbErr){ toast('Errore salvataggio DB: ' + dbErr.message, false); return; }

    toast('File caricato e salvato!');
    $('file-input').value = '';
    $('file-info').textContent = 'Nessun file selezionato';
    $('title').value=''; $('author').value='';
    loadBooks();
  }catch(err){
    console.error(err);
    toast('Errore imprevisto durante upload', false);
  }
}

$('file-input').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  $('file-info').textContent = f ? f.name : 'Nessun file selezionato';
});

$('upload-btn').onclick = uploadFileAndSave;
$('clear-btn').onclick = ()=>{
  $('file-input').value='';
  $('file-info').textContent='Nessun file selezionato';
  $('title').value=''; $('author').value='';
};

// --- Load / Render books ---
async function loadBooks(){
  if(!currentUser) return;
  const q = supabase.from('books').select('*').eq('user_id', currentUser.id).order('title',{ascending:true});
  const { data, error } = await q;
  console.log('books', data, error);
  if(error){ toast('Errore caricamento libri', false); return; }
  renderBooks(data || []);
}

function renderBooks(items){
  const list = $('books-list');
  list.innerHTML = '';
  if(!items || items.length===0){
    list.innerHTML = '<div class="text-gray-600">Nessun libro ancora</div>';
    return;
  }
  items.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="font-bold mb-1">${escapeHtml(it.title)}</div>
      <div class="text-sm text-gray-600 mb-3">di ${escapeHtml(it.author || '')}</div>
      <div class="flex gap-2">
        <button class="btn bg-amber-500 text-white open-btn">Apri</button>
        <button class="btn bg-blue-500 text-white edit-btn">Modifica</button>
        <button class="btn bg-red-500 text-white del-btn">Elimina</button>
      </div>
    `;
    // open
    card.querySelector('.open-btn').addEventListener('click', ()=> {
      if(it.file_url) window.open(it.file_url, '_blank');
      else toast('File non disponibile', false);
    });
    // edit
    card.querySelector('.edit-btn').addEventListener('click', ()=>{
      editingId = it.id;
      $('title').value = it.title;
      $('author').value = it.author;
      // note: we do not change file on edit here; user can upload new file separately if needed
      window.scrollTo({top:0, behavior:'smooth'});
      $('form-modal')?.classList && $('form-modal').classList.remove('hidden');
      // show upload card already visible: keep focus
    });
    // delete
    card.querySelector('.del-btn').addEventListener('click', async ()=>{
      if(!confirm('Eliminare questo libro?')) return;
      // delete DB row
      const { error: delErr } = await supabase.from('books').delete().eq('id', it.id);
      if(delErr){ toast('Errore eliminazione: ' + delErr.message, false); return; }
      // optionally delete from storage if we can derive path (public URL contains path after /storage/v1/object/public/)
      // try to remove storage object if it fits pattern
      try{
        const url = new URL(it.file_url);
        const parts = url.pathname.split('/'); // /storage/v1/object/public/<bucket>/<path...>
        const idx = parts.indexOf('public');
        if(idx>=0 && parts.length>idx+1){
          const bucket = parts[idx+1];
          const objectPath = parts.slice(idx+2).join('/');
          const { error: remErr } = await supabase.storage.from(bucket).remove([objectPath]);
          if(remErr) console.warn('errore rimozione file storage', remErr);
        }
      }catch(e){ console.warn('impossible to remove storage file', e); }
      toast('Eliminato');
      loadBooks();
    });
    list.appendChild(card);
  });
}

// search
$('search').addEventListener('input', async (e)=>{
  const q = supabase.from('books').select('*').eq('user_id', currentUser.id)
    .or(`title.ilike.%${e.target.value}%,author.ilike.%${e.target.value}%`).order('title',{ascending:true});
  const { data, error } = await q;
  if(error) { console.error(error); return; }
  renderBooks(data || []);
});

// helper escape
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// Load initial (if already logged)
supabase.auth.getSession().then(({ data })=>{
  if(data && data.session && data.session.user){ currentUser = data.session.user; $('auth-info').textContent = 'Connesso: ' + (currentUser.email || currentUser.id); $('upload-card').classList.remove('hidden'); $('books-card').classList.remove('hidden'); loadBooks(); }
});
</script>
</body>
</html>
le.warn('impossible to remove s

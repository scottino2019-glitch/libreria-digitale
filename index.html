<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üìö La Tua Biblioteca Digitale</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

<!-- üìÑ Libreria pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<style>
body {
  background: linear-gradient(135deg, #f5deb3, #deb887);
  font-family: 'Georgia', serif;
}
.book-card {
  background-color: #fff8dc;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.book-card:hover {
  transform: translateY(-5px);
}
#reader-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.9);
  z-index: 999;
  display: none;
  flex-direction: column;
}
#reader-content {
  flex: 1;
  overflow: auto;
  background: white;
}
</style>
</head>

<body class="min-h-screen p-4">

<!-- Autenticazione -->
<div id="auth-section" class="max-w-sm mx-auto bg-white rounded-lg shadow-lg p-6">
  <h1 class="text-2xl font-bold text-center mb-4">üìö La Tua Biblioteca Digitale</h1>
  <input id="email" type="email" placeholder="Email" class="w-full mb-2 p-2 border rounded">
  <input id="password" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded">
  <div class="flex justify-between">
    <button id="login-btn" class="bg-green-600 text-white px-4 py-2 rounded">Accedi</button>
    <button id="register-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Registrati</button>
  </div>
  <div id="auth-message" class="mt-4 text-center text-sm text-gray-700"></div>
</div>

<!-- Biblioteca -->
<div id="library-section" class="hidden max-w-5xl mx-auto">
  <div class="flex justify-between items-center mb-4">
    <input id="search-bar" type="text" placeholder="Cerca libro..." class="p-2 border rounded w-2/3">
    <div class="flex gap-2">
      <input id="file-upload" type="file" class="hidden" />
      <button id="add-book-btn" class="bg-blue-600 text-white px-4 py-2 rounded">üì§ Aggiungi Libro</button>
      <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded">üö™ Logout</button>
    </div>
  </div>
  <div id="books-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
</div>

<!-- Lettore -->
<div id="reader-modal">
  <div class="flex justify-between bg-gray-800 text-white p-2">
    <h2 id="reader-title" class="text-lg font-bold">üìñ Lettore</h2>
    <button onclick="closeReader()" class="bg-red-600 px-4 py-1 rounded">Chiudi</button>
  </div>
  <div id="reader-content" class="p-2"></div>
</div>

<script>
// Configurazione Supabase
const { createClient } = supabase;
const supabaseClient = createClient(
  "https://ipdhzwkyzvpwtcoekhog.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZGh6d2t5enZwd3Rjb2VraG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDYyNzMsImV4cCI6MjA3MDMyMjI3M30.50O7BW_34dD9fcza9zDi5WuhW-r9EVinopMLOnhqQtA"
);

let userId = null;

// Fetch libri
async function fetchBooks(search = "") {
  let query = supabaseClient
    .from("books")
    .select("*")
    .eq("user_id", userId)
    .order("title", { ascending: true });

  if (search) {
    query = query.ilike("title", `%${search}%`);
  }

  const { data, error } = await query;
  if (error) {
    console.error(error);
    return;
  }
  renderBooks(data);
}

// Render libri
function renderBooks(books) {
  const container = document.getElementById("books-list");
  if (!books.length) {
    container.innerHTML = `<div class="text-center text-gray-500 col-span-full">Nessun libro trovato</div>`;
    return;
  }
  container.innerHTML = books.map(book => `
    <div class="book-card flex flex-col justify-between">
      <div>
        <h3 class="font-bold">${book.title}</h3>
        <p class="text-sm text-gray-600">${book.author || ""}</p>
      </div>
      <div class="flex justify-between mt-4">
        <button onclick="openReader('${book.file_url}', '${book.title}')" class="bg-green-500 text-white px-2 py-1 rounded">üìñ Leggi</button>
        <button onclick="editBook('${book.id}', '${book.title}', '${book.author}')" class="bg-yellow-500 text-white px-2 py-1 rounded">‚úèÔ∏è Modifica</button>
        <button onclick="deleteBook('${book.id}')" class="bg-red-500 text-white px-2 py-1 rounded">üóëÔ∏è Elimina</button>
      </div>
    </div>
  `).join("");
}

// Lettore con pdf.js ed epub.js
function openReader(url, title) {
  document.getElementById("reader-title").textContent = title;
  const readerContent = document.getElementById("reader-content");
  readerContent.innerHTML = "";

  if (url.toLowerCase().endsWith(".pdf")) {
    const canvas = document.createElement("canvas");
    readerContent.appendChild(canvas);
    const ctx = canvas.getContext("2d");

    pdfjsLib.getDocument(url).promise.then(pdf => {
      pdf.getPage(1).then(page => {
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        page.render({ canvasContext: ctx, viewport: viewport });
      });
    }).catch(err => {
      readerContent.innerHTML = `<p class="p-4 text-red-500">Errore caricamento PDF: ${err.message}</p>`;
    });
  } else if (url.toLowerCase().endsWith(".epub")) {
    const book = ePub(url);
    const rendition = book.renderTo(readerContent, { width: "100%", height: "100%" });
    rendition.display();
  } else {
    readerContent.innerHTML = `<p class="p-4">Formato non supportato.</p>`;
  }

  document.getElementById("reader-modal").style.display = "flex";
}

function closeReader() {
  document.getElementBy

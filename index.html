<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üìö La Tua Biblioteca Digitale</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  background: linear-gradient(135deg, #f5deb3, #deb887);
  font-family: 'Georgia', serif;
}
.book-card {
  background-color: #fff8dc;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.book-card:hover {
  transform: translateY(-5px);
}
#pdf-viewer {
            width: 100%;
            height: 70vh;
            border: 1px solid #ccc;
        }
        
        .pdf-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .pdf-controls button {
            padding: 0.5rem 1rem;
        }
        
        .empty-shelf {
            color: var(--color-paper);
            text-align: center;
            padding: 2rem;
            font-style: italic;
        }
</style>
</head>

<body class="min-h-screen p-4">

<!-- Autenticazione -->
<div id="auth-section" class="max-w-sm mx-auto bg-white rounded-lg shadow-lg p-6">
  <h1 class="text-2xl font-bold text-center mb-4">üìö La Tua Biblioteca Digitale</h1>
  <input id="email" type="email" placeholder="Email" class="w-full mb-2 p-2 border rounded">
  <input id="password" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded">
  <div class="flex justify-between">
    <button id="login-btn" class="bg-green-600 text-white px-4 py-2 rounded">Accedi</button>
    <button id="register-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Registrati</button>
  </div>
  <div id="auth-message" class="mt-4 text-center text-sm text-gray-700"></div>
</div>

<!-- Biblioteca -->
<div id="library-section" class="hidden max-w-5xl mx-auto">
  <div class="flex justify-between items-center mb-4">
    <input id="search-bar" type="text" placeholder="Cerca libro..." class="p-2 border rounded w-2/3">
    <div class="flex gap-2">
      <input id="file-upload" type="file" class="hidden" />
      <button id="add-book-btn" class="bg-blue-600 text-white px-4 py-2 rounded">üì§ Aggiungi Libro</button>
      <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded">üö™ Logout</button>
    </div>
  </div>
  <div id="books-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
</div>

<script>
// Configurazione Supabase
const { createClient } = supabase;
const supabaseClient = createClient(
  "https://ipdhzwkyzvpwtcoekhog.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZGh6d2t5enZwd3Rjb2VraG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDYyNzMsImV4cCI6MjA3MDMyMjI3M30.50O7BW_34dD9fcza9zDi5WuhW-r9EVinopMLOnhqQtA"
);

let userId = null;

// Fetch libri
async function fetchBooks(search = "") {
  let query = supabaseClient
    .from("books")
    .select("*")
    .eq("user_id", userId)
    .order("title", { ascending: true });

  if (search) {
    query = query.ilike("title", `%${search}%`);
  }

  const { data, error } = await query;
  if (error) {
    console.error(error);
    return;
  }
  renderBooks(data);
}

// Render libri
function renderBooks(books) {
  const container = document.getElementById("books-list");
  if (!books.length) {
    container.innerHTML = `<div class="text-center text-gray-500 col-span-full">Nessun libro trovato</div>`;
    return;
  }
  container.innerHTML = books.map(book => `
    <div class="book-card flex flex-col justify-between">
      <div>
        <h3 class="font-bold">${book.title}</h3>
        <p class="text-sm text-gray-600">${book.author || ""}</p>
      </div>
      <div class="flex justify-between mt-4">
        <a href="${id="pdf-modal'}" target="_blank" class="bg-green-500 text-white px-2 py-1 rounded">üìñ Leggi</a>
<div class="modal" id="pdf-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-modal">&times;</button>
            <h2 id="modal-title">Titolo del libro</h2>
            <p id="modal-author">Autore: </p>
            
            <div class="pdf-controls">
                <button id="prev-page"><i class="fas fa-arrow-left"></i> Precedente</button>
                <span id="page-num">Pagina 1 di 1</span>
                <button id="next-page">Successiva <i class="fas fa-arrow-right"></i></button>
                <button id="download-pdf"><i class="fas fa-download"></i> Scarica</button>
            </div>
            
            <canvas id="pdf-canvas"></canvas>
        </div>
    </div>
        <button onclick="editBook('${book.id}', '${book.title}', '${book.author}')" class="bg-yellow-500 text-white px-2 py-1 rounded">‚úèÔ∏è Modifica</button>
        <button onclick="deleteBook('${book.id}')" class="bg-red-500 text-white px-2 py-1 rounded">üóëÔ∏è Elimina</button>
      </div>
    </div>
  `).join("");
}

// Upload libro (fix estensione)
document.getElementById("add-book-btn").addEventListener("click", () => {
  document.getElementById("file-upload").click();
});

document.getElementById("file-upload").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const title = prompt("Titolo del libro:");
  const author = prompt("Autore del libro:");

  let fileName = file.name;
  if (!fileName.includes(".")) {
    const ext = file.type.split("/")[1] || "pdf";
    fileName = `${fileName}.${ext}`;
  }

  const { error: storageError } = await supabaseClient
    .storage
    .from("books-storage")
    .upload(`${userId}/${fileName}`, file, { upsert: true });

  if (storageError) {
    alert("Errore upload file: " + storageError.message);
    return;
  }

  const fileUrl = supabaseClient
    .storage
    .from("books-storage")
    .getPublicUrl(`${userId}/${fileName}`).data.publicUrl;

  const { error: insertError } = await supabaseClient
    .from("books")
    .insert([{ title, author, file_url: fileUrl, user_id: userId }]);

  if (insertError) {
    alert("Errore salvataggio libro: " + insertError.message);
    return;
  }

  fetchBooks();
});
//PDF reader//
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        // Inizializza PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        document.addEventListener('DOMContentLoaded', function() {
            // Elementi DOM
            const uploadForm = document.getElementById('upload-form');
            const authorsList = document.getElementById('authors-list');
            const booksGrid = document.getElementById('books-grid');
            const shelfTitle = document.getElementById('shelf-title');
            const pdfModal = document.getElementById('pdf-modal');
            const closeModal = document.getElementById('close-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalAuthor = document.getElementById('modal-author');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const pageNumSpan = document.getElementById('page-num');
            const downloadPdfBtn = document.getElementById('download-pdf');
            const statsBooks = document.getElementById('stats-books');
            const statsAuthors = document.getElementById('stats-authors');
            
            // Variabili per la gestione del PDF
            let currentPdf = null;
            let currentPage = 1;
            let currentPdfData = null;
            let pageRendering = false;
            let pageNumPending = null;
            let pdfScale = 1.5;
            
            // Dati della libreria
            let library = JSON.parse(localStorage.getItem('digitalLibrary')) || {};
            let currentAuthor = 'all';
            
            // Inizializza la libreria
            initializeLibrary();
            updateStats();
            
            // Gestione invio form
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const author = document.getElementById('author').value.trim();
                const title = document.getElementById('title').value.trim();
                const fileInput = document.getElementById('pdf-file');
                const file = fileInput.files[0];
                
                if (author && title && file) {
                    // Leggi il file come URL
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addBookToLibrary(author, title, e.target.result);
                        uploadForm.reset();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Chiudi il modal
            closeModal.addEventListener('click', function() {
                pdfModal.style.display = 'none';
                currentPdf = null;
            });
            
            // Chiudi il modal cliccando fuori
            window.addEventListener('click', function(e) {
                if (e.target === pdfModal) {
                    pdfModal.style.display = 'none';
                    currentPdf = null;
                }
            });
            
            // Navigazione tra le pagine del PDF
            prevPageBtn.addEventListener('click', function() {
                if (currentPdf && currentPage > 1) {
                    currentPage--;
                    queueRenderPage(currentPage);
                }
            });
            
            nextPageBtn.addEventListener('click', function() {
                if (currentPdf && currentPage < currentPdf.numPages) {
                    currentPage++;
                    queueRenderPage(currentPage);
                }
            });
            
            // Download del PDF
            downloadPdfBtn.addEventListener('click', function() {
                if (currentPdfData) {
                    const link = document.createElement('a');
                    link.href = currentPdfData;
                    link.download = `${modalTitle.textContent}.pdf`;
                    link.click();
                }
            });
// Modifica libro
async function editBook(id, oldTitle, oldAuthor) {
  const newTitle = prompt("Nuovo titolo:", oldTitle);
  const newAuthor = prompt("Nuovo autore:", oldAuthor);

  const { error } = await supabaseClient
    .from("books")
    .update({ title: newTitle, author: newAuthor })
    .eq("id", id)
    .eq("user_id", userId);

  if (error) {
    alert("Errore modifica: " + error.message);
    return;
  }
  fetchBooks();
}

// Elimina libro
async function deleteBook(id) {
  if (!confirm("Sei sicuro di voler eliminare questo libro?")) return;
  const { error } = await supabaseClient
    .from("books")
    .delete()
    .eq("id", id)
    .eq("user_id", userId);
  if (error) {
    alert("Errore eliminazione: " + error.message);
    return;
  }
  fetchBooks();
}

// Ricerca
document.getElementById("search-bar").addEventListener("input", (e) => {
  fetchBooks(e.target.value);
});

// Autenticazione
document.getElementById("login-btn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
  document.getElementById("auth-message").textContent = error ? error.message : "Login effettuato!";
};

document.getElementById("register-btn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { error } = await supabaseClient.auth.signUp({ email, password });
  document.getElementById("auth-message").textContent = error ? error.message : "Registrazione completata! Controlla la tua email.";
};

// Logout immediato senza refresh
document.getElementById("logout-btn").onclick = async () => {
  await supabaseClient.auth.signOut();
  userId = null;
  document.getElementById("auth-section").classList.remove("hidden");
  document.getElementById("library-section").classList.add("hidden");
};

// Stato auth
supabaseClient.auth.onAuthStateChange((event, session) => {
  if (session) {
    userId = session.user.id;
    document.getElementById("auth-section").classList.add("hidden");
    document.getElementById("library-section").classList.remove("hidden");
    fetchBooks();
  } else {
    userId = null;
    document.getElementById("auth-section").classList.remove("hidden");
    document.getElementById("library-section").classList.add("hidden");
  }
});
</script>
</body>
</html>

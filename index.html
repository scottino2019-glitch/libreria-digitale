
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“š La Tua Libreria Felice</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://kit.fontawesome.com/a2e0e6ad0f.js" crossorigin="anonymous"></script>
<style>
.book {
  height: 12rem;
  width: 8rem;
  background-color: #8B5E3C;
  color: white;
  padding: 0.5rem;
  border-radius: 8px;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
}
.book:hover {
  transform: translateY(-5px) scale(1.05);
  box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
}
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  padding: 1rem;
}
.modal-content {
  background-color: white;
  border-radius: 12px;
  padding: 2rem;
  max-width: 600px;
  width: 100%;
}
</style>
</head>
<body class="bg-yellow-100 min-h-screen p-6">

<!-- Sezione autenticazione -->
<div id="auth-section" class="max-w-sm mx-auto bg-white p-6 rounded-xl shadow-lg">
  <h1 class="text-3xl font-bold text-center mb-4 text-yellow-700">ðŸ“š La Tua Libreria Felice</h1>
  <input id="email" type="email" placeholder="Email" class="w-full mb-2 p-2 border rounded">
  <input id="password" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded">
  <div class="flex justify-between">
    <button id="login-btn" class="bg-green-500 text-white px-4 py-2 rounded">Accedi</button>
    <button id="register-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Registrati</button>
  </div>
</div>

<!-- Sezione libreria -->
<div id="library-section" class="hidden max-w-5xl mx-auto mt-6">
  <div class="flex justify-between items-center mb-4">
    <input id="search-bar" type="text" placeholder="ðŸ” Cerca libro..." class="p-2 border rounded w-2/3">
    <button id="add-book-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Aggiungi Libro</button>
    <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
  </div>
  <div id="books-list" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
</div>

<!-- Modal per aggiungere/modificare -->
<div id="form-modal" class="modal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4">ðŸ“– Aggiungi/Modifica Libro</h2>
    <input id="book-title" placeholder="Titolo" class="w-full mb-2 p-2 border rounded">
    <input id="book-author" placeholder="Autore" class="w-full mb-2 p-2 border rounded">
    <textarea id="book-content" placeholder="Contenuto" class="w-full mb-4 p-2 border rounded"></textarea>
    <div class="flex justify-between">
      <button id="save-book-btn" class="bg-green-500 text-white px-4 py-2 rounded">Salva</button>
      <button onclick="document.getElementById('form-modal').style.display='none'" class="bg-gray-400 text-white px-4 py-2 rounded">Chiudi</button>
    </div>
  </div>
</div>

<!-- Modal per lettura -->
<div id="read-modal" class="modal">
  <div class="modal-content">
    <h2 id="read-title" class="text-xl font-bold mb-4"></h2>
    <p id="read-author" class="text-gray-600 mb-4"></p>
    <div id="read-content" class="whitespace-pre-line"></div>
    <div class="mt-4 text-right">
      <button onclick="document.getElementById('read-modal').style.display='none'" class="bg-red-500 text-white px-4 py-2 rounded">Chiudi</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const supabaseClient = supabase.createClient(
  "https://ipdhzwkyzvpwtcoekhog.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZGh6d2t5enZwd3Rjb2VraG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDYyNzMsImV4cCI6MjA3MDMyMjI3M30.50O7BW_34dD9fcza9zDi5WuhW-r9EVinopMLOnhqQtA"
);

let userId = null;
let editingBookId = null;

async function fetchBooks() {
  if (!userId) return;
  const searchTerm = document.getElementById("search-bar").value.toLowerCase();
  let { data: books, error } = await supabaseClient
    .from("books")
    .select("*")
    .eq("user_id", userId)
    .order("title", { ascending: true });
  if (error) { console.error(error); return; }
  if (searchTerm) {
    books = books.filter(b => b.title.toLowerCase().includes(searchTerm));
  }
  renderBooks(books);
}

function renderBooks(books) {
  const container = document.getElementById("books-list");
  if (!books.length) {
    container.innerHTML = '<div class="col-span-full text-center text-gray-500">Nessun libro trovato</div>';
    return;
  }
  container.innerHTML = books.map(book => `
    <div class="book">
      <div class="font-bold">${book.title}</div>
      <div class="text-sm">${book.author}</div>
      <div class="mt-2 flex gap-1">
        <button onclick="readBook('${book.id}')" class="bg-yellow-400 px-2 py-1 rounded text-xs">Leggi</button>
        <button onclick="editBook('${book.id}')" class="bg-blue-400 px-2 py-1 rounded text-xs">Modifica</button>
        <button onclick="deleteBook('${book.id}')" class="bg-red-400 px-2 py-1 rounded text-xs">Elimina</button>
      </div>
    </div>
  `).join("");
}

async function readBook(id) {
  const { data } = await supabaseClient.from("books").select("*").eq("id", id).single();
  document.getElementById("read-title").textContent = data.title;
  document.getElementById("read-author").textContent = "di " + data.author;
  document.getElementById("read-content").textContent = data.content;
  document.getElementById("read-modal").style.display = "flex";
}

function editBook(id) {
  editingBookId = id;
  supabaseClient.from("books").select("*").eq("id", id).single().then(({ data }) => {
    document.getElementById("book-title").value = data.title;
    document.getElementById("book-author").value = data.author;
    document.getElementById("book-content").value = data.content;
    document.getElementById("form-modal").style.display = "flex";
  });
}

async function deleteBook(id) {
  if (confirm("Sei sicuro di voler eliminare questo libro?")) {
    await supabaseClient.from("books").delete().eq("id", id);
    fetchBooks();
  }
}

document.getElementById("add-book-btn").onclick = () => {
  editingBookId = null;
  document.getElementById("book-title").value = "";
  document.getElementById("book-author").value = "";
  document.getElementById("book-content").value = "";
  document.getElementById("form-modal").style.display = "flex";
};

document.getElementById("save-book-btn").onclick = async () => {
  const title = document.getElementById("book-title").value;
  const author = document.getElementById("book-author").value;
  const content = document.getElementById("book-content").value;
  if (editingBookId) {
    await supabaseClient.from("books").update({ title, author, content }).eq("id", editingBookId);
  } else {
    await supabaseClient.from("books").insert([{ title, author, content, user_id: userId }]);
  }
  document.getElementById("form-modal").style.display = "none";
  fetchBooks();
};

document.getElementById("login-btn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) alert(error.message);
};

document.getElementById("register-btn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { error } = await supabaseClient.auth.signUp({ email, password });
  if (error) alert(error.message);
  else alert("Registrazione avvenuta! Controlla la tua email per confermare.");
};

document.getElementById("logout-btn").onclick = async () => {
  await supabaseClient.auth.signOut();
};

document.getElementById("search-bar").oninput = fetchBooks;

supabaseClient.auth.onAuthStateChange((_event, session) => {
  if (session) {
    userId = session.user.id;
    document.getElementById("auth-section").classList.add("hidden");
    document.getElementById("library-section").classList.remove("hidden");
    fetchBooks();
  } else {
    userId = null;
    document.getElementById("auth-section").classList.remove("hidden");
    document.getElementById("library-section").classList.add("hidden");
  }
});
</script>
</body>
</html>
